# âœ… å…ƒæ•°æ®è¡¨åŒæ­¥åŠŸèƒ½å·²å®Œæˆ

## é—®é¢˜å›é¡¾

**ç”¨æˆ·åé¦ˆ**ï¼š
> "ç°åœ¨è¿˜æ˜¯åœ¨difyçŸ¥è¯†åº“ä¸­åˆ é™¤æ–‡ä»¶åï¼Œå…ƒæ•°æ®è¡¨æ ¼ä¸ä¼šåŒæ­¥åˆ é™¤ï¼Œå¯¼è‡´æ•°æ®ä¸æ­£ç¡®"

## è§£å†³æ–¹æ¡ˆ

### å·²å®ç°åŠŸèƒ½

âœ… **åŒæ­¥ SQLite æ•°æ®åº“**ï¼ˆå·²æœ‰ï¼‰
- åˆ é™¤å·²åœ¨ Dify ä¸­åˆ é™¤çš„æ–‡æ¡£è®°å½•
- é€šè¿‡æ–‡æ¡£ ID ç²¾ç¡®åŒ¹é…

âœ… **åŒæ­¥ CSV å…ƒæ•°æ®è¡¨**ï¼ˆæ–°å¢ï¼‰
- åˆ é™¤å·²åœ¨ Dify ä¸­åˆ é™¤çš„æ–‡æ¡£å…ƒæ•°æ®
- é€šè¿‡æ–‡ä»¶åæ™ºèƒ½åŒ¹é…ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰

### æ–‡ä»¶ä¿®æ”¹

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¯´æ˜ |
|-----|---------|------|
| `utils/metadata_manager.py` | æ–°å¢åˆ é™¤æ–¹æ³• | `delete_by_title()`, `delete_by_titles()`, `get_all_titles()`, `count()` |
| `sync_metadata.py` | å¢å¼ºåŒæ­¥é€»è¾‘ | åŒæ—¶åŒæ­¥æ•°æ®åº“å’Œ CSVï¼Œæ™ºèƒ½æ–‡ä»¶ååŒ¹é… |
| `upload_enhanced.py` | æ›´æ–°è‡ªåŠ¨åŒæ­¥ | `sync_with_dify()` å‡½æ•°æ”¯æŒå…ƒæ•°æ®è¡¨åŒæ­¥ |
| `test_sync.py` | æµ‹è¯•è„šæœ¬ | ç”¨äºæµ‹è¯•åŒæ­¥åŠŸèƒ½ |
| `test_metadata_sync.bat` | æ‰¹å¤„ç†å·¥å…· | Windows å‹å¥½çš„æµ‹è¯•ç•Œé¢ |
| `METADATA_SYNC_GUIDE.md` | ä½¿ç”¨æ–‡æ¡£ | å®Œæ•´çš„ä½¿ç”¨è¯´æ˜å’Œç¤ºä¾‹ |

## ä½¿ç”¨æ–¹æ³•

### æ–¹å¼ 1ï¼šè‡ªåŠ¨åŒæ­¥ï¼ˆæ¨èï¼‰â­

```yaml
# config.yaml
database:
  auto_sync: true  # å¯åŠ¨æ—¶è‡ªåŠ¨åŒæ­¥
```

**è¿è¡Œï¼š**
```cmd
python upload_enhanced.py
```

**æ•ˆæœï¼š**
- è‡ªåŠ¨æ¸…ç†æ•°æ®åº“å†—ä½™è®°å½•
- è‡ªåŠ¨æ¸…ç†å…ƒæ•°æ®è¡¨å†—ä½™è®°å½•

### æ–¹å¼ 2ï¼šæ‰‹åŠ¨åŒæ­¥

```cmd
# 1. æŸ¥çœ‹å½“å‰çŠ¶æ€
python test_sync.py

# 2. æ¨¡æ‹ŸåŒæ­¥ï¼ˆä¸åˆ é™¤ï¼‰
python sync_metadata.py --dry-run

# 3. æ­£å¼åŒæ­¥
python sync_metadata.py
```

### æ–¹å¼ 3ï¼šæ‰¹å¤„ç†å·¥å…·

```cmd
# åŒå‡»è¿è¡Œ
test_metadata_sync.bat
```

## åŒæ­¥é€»è¾‘

### æ•°æ®åº“åŒæ­¥ï¼ˆé€šè¿‡æ–‡æ¡£ IDï¼‰

```python
# 1. è·å– Dify ä¸­çš„æ–‡æ¡£ ID
dify_doc_ids = ["doc-id-1", "doc-id-2", ...]

# 2. è·å–æœ¬åœ°æ•°æ®åº“ä¸­çš„æ–‡æ¡£ ID
local_doc_ids = ["doc-id-1", "doc-id-2", "doc-id-3", ...]

# 3. è®¡ç®—å·®é›†
to_delete = local_doc_ids - dify_doc_ids
# ç»“æœ: ["doc-id-3"]

# 4. åˆ é™¤
upload_logger.sync_with_dify(dify_doc_ids)
```

### å…ƒæ•°æ®è¡¨åŒæ­¥ï¼ˆé€šè¿‡æ–‡ä»¶åï¼‰

```python
# 1. è·å– Dify ä¸­çš„æ–‡æ¡£åï¼ˆå¤„ç†åï¼‰
dify_names = ["æ–‡æ¡£1", "æ–‡æ¡£2", ...]  # å·²ç§»é™¤ _ocr.md å’Œæ‰©å±•å

# 2. è·å–å…ƒæ•°æ®è¡¨ä¸­çš„æ ‡é¢˜
local_titles = ["æ–‡æ¡£1", "æ–‡æ¡£2", "æ–‡æ¡£3", ...]

# 3. æ™ºèƒ½åŒ¹é…ï¼ˆç§»é™¤ç‰¹æ®Šå­—ç¬¦ã€æ¨¡ç³Šå¯¹æ¯”ï¼‰
for title in local_titles:
    normalized = title.replace('ã€Š', '').replace('ã€‹', '')
    if not found_in_dify(normalized):
        to_delete.append(title)

# 4. æ‰¹é‡åˆ é™¤
metadata_manager.delete_by_titles(to_delete)
```

### æ–‡ä»¶ååŒ¹é…ç¤ºä¾‹

| Dify æ–‡æ¡£å | å¤„ç†å | å…ƒæ•°æ®æ ‡é¢˜ | åŒ¹é…ç»“æœ |
|-----------|--------|----------|---------|
| `æ–‡æ¡£_ocr.md` | `æ–‡æ¡£` | `æ–‡æ¡£` | âœ… ç²¾ç¡®åŒ¹é… |
| `2025-æ”¿ç­–.pdf` | `2025-æ”¿ç­–` | `2025-ã€Šæ”¿ç­–æ–‡ä»¶ã€‹` | âœ… æ¨¡ç³ŠåŒ¹é… |
| `æŒ‡å—(è¯•è¡Œ).docx` | `æŒ‡å—(è¯•è¡Œ)` | `æŒ‡å—ï¼ˆè¯•è¡Œï¼‰` | âœ… æ¨¡ç³ŠåŒ¹é… |
| `deleted.pdf` | `deleted` | `å·²åˆ é™¤çš„æ–‡æ¡£` | âŒ ä¸åŒ¹é… â†’ åˆ é™¤ |

## æµ‹è¯•è¾“å‡ºç¤ºä¾‹

### æµ‹è¯•æ¨¡å¼

```cmd
> python test_sync.py

============================================================
æµ‹è¯•å…ƒæ•°æ®åŒæ­¥åŠŸèƒ½
============================================================
[INFO] å…ƒæ•°æ®æ–‡ä»¶: ./metadata/source_table.csv
[INFO] å½“å‰è®°å½•æ•°: 15

å½“å‰å…ƒæ•°æ®è®°å½•ï¼š
  1. 2025-ã€Šå…³äºå¼ºåŒ–å›½åœŸç©ºé—´è§„åˆ’...ã€‹
  2. 2025.10-çœçº§å›½åœŸç©ºé—´ç”Ÿæ€ä¿®å¤...
  3. å®‰å¾½çœå…¨åŸŸåœŸåœ°ç»¼åˆæ•´æ²»...
  ... ä»¥åŠå…¶ä»– 12 æ¡è®°å½•

============================================================
[WARNING] ä»¥ä¸‹æ˜¯æµ‹è¯•æ¨¡å¼ï¼Œä¸ä¼šå®é™…åˆ é™¤
============================================================
```

### æ¨¡æ‹ŸåŒæ­¥

```cmd
> python sync_metadata.py --dry-run

========================================
  Dify æ–‡æ¡£åŒæ­¥å·¥å…·
========================================

[SUCCESS] é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ
[INFO] æœ¬åœ°æ•°æ®åº“ä¸­æœ‰ 25 æ¡ä¸Šä¼ è®°å½•
[INFO] æœ¬åœ°å…ƒæ•°æ®è¡¨ä¸­æœ‰ 28 æ¡è®°å½•
[INFO] æ­£åœ¨ä» Dify è·å–æ–‡æ¡£åˆ—è¡¨...
  [INFO] ç¬¬ 1 é¡µ: 22 ä¸ªæ–‡æ¡£
[SUCCESS] æˆåŠŸè·å– 22 ä¸ªæ–‡æ¡£
[INFO] Dify çŸ¥è¯†åº“ä¸­æœ‰ 22 ä¸ªæ–‡æ¡£

==================================================
[WARNING] æ•°æ®åº“ï¼šå‘ç° 3 æ¡éœ€è¦æ¸…ç†çš„è®°å½•
[WARNING] å…ƒæ•°æ®è¡¨ï¼šå‘ç° 6 æ¡éœ€è¦æ¸…ç†çš„è®°å½•

å¾…åˆ é™¤çš„æ•°æ®åº“è®°å½•ï¼ˆæ–‡æ¡£ IDï¼‰ï¼š
  1. 0a09c548-6232-4a...
  2. 9f8f3bc4-b8fc-4f...
  3. 1234abcd-5678-ef...

å¾…åˆ é™¤çš„å…ƒæ•°æ®è®°å½•ï¼ˆæ ‡é¢˜ï¼‰ï¼š
  1. 2025-å·²åˆ é™¤çš„æ–‡æ¡£1
  2. 2024-å·²åˆ é™¤çš„æ–‡æ¡£2
  3. å†å²é—ç•™æ–‡æ¡£3
  ... ä»¥åŠå…¶ä»– 3 æ¡è®°å½•
==================================================

[WARNING] âš ï¸ è¿™æ˜¯æ¨¡æ‹Ÿè¿è¡Œï¼Œä¸ä¼šå®é™…åˆ é™¤è®°å½•
```

### æ­£å¼åŒæ­¥

```cmd
> python sync_metadata.py

[æ­£å¸¸è¾“å‡º...]

æ˜¯å¦ç»§ç»­åˆ é™¤è¿™äº›è®°å½•ï¼Ÿ[y/N]: y

[SUCCESS] âœ… æ•°æ®åº“ï¼šæˆåŠŸåˆ é™¤ 3 æ¡è®°å½•
[SUCCESS] âœ… å…ƒæ•°æ®è¡¨ï¼šæˆåŠŸåˆ é™¤ 6 æ¡è®°å½•

ğŸ‰ åŒæ­¥å®Œæˆï¼æ€»å…±åˆ é™¤ 9 æ¡è®°å½•
```

### è‡ªåŠ¨åŒæ­¥ï¼ˆå¯åŠ¨æ—¶ï¼‰

```cmd
> python upload_enhanced.py

[INFO] å¼€å§‹ä¸ Dify åŒæ­¥...
[SUCCESS] âœ… åŒæ­¥å®Œæˆï¼šæ•°æ®åº“ 3 æ¡ï¼Œå…ƒæ•°æ®è¡¨ 6 æ¡

[INFO] å¼€å§‹ç›‘æ§æ–‡ä»¶å¤¹: C:\Users\Moon\Desktop\...
```

## ä»£ç ç¤ºä¾‹

### MetadataManager æ–°å¢æ–¹æ³•

```python
# åˆ é™¤å•æ¡è®°å½•
metadata_manager.delete_by_title("æ–‡æ¡£æ ‡é¢˜")
# è¿”å›: True/False

# æ‰¹é‡åˆ é™¤
deleted = metadata_manager.delete_by_titles(["æ ‡é¢˜1", "æ ‡é¢˜2"])
# è¿”å›: 2 (åˆ é™¤çš„æ•°é‡)

# è·å–æ‰€æœ‰æ ‡é¢˜
titles = metadata_manager.get_all_titles()
# è¿”å›: ["æ ‡é¢˜1", "æ ‡é¢˜2", ...]

# è·å–æ€»æ•°
count = metadata_manager.count()
# è¿”å›: 15
```

### sync_metadata.py æ ¸å¿ƒé€»è¾‘

```python
# 1. åˆå§‹åŒ–ç®¡ç†å™¨
metadata_manager = MetadataManager(csv_path, auto_create=True)

# 2. è·å– Dify æ–‡æ¡£
dify_documents = get_dify_documents(config)  # è¿”å› [{'id': ..., 'name': ...}, ...]

# 3. æå–æ–‡ä»¶åï¼ˆå¤„ç†æ‰©å±•åï¼‰
dify_names = set()
for doc in dify_documents:
    name = doc['name']
    if name.endswith('_ocr.md'):
        name = name[:-7]
    elif '.' in name:
        name = os.path.splitext(name)[0]
    dify_names.add(name)

# 4. æ‰¾å‡ºéœ€è¦åˆ é™¤çš„å…ƒæ•°æ®
to_delete = []
for title in metadata_manager.get_all_titles():
    if not found_in_dify(title, dify_names):
        to_delete.append(title)

# 5. æ‰¹é‡åˆ é™¤
deleted = metadata_manager.delete_by_titles(to_delete)
```

## éªŒè¯æ­¥éª¤

### 1. æµ‹è¯•åˆ é™¤åŠŸèƒ½ï¼ˆä¸å®é™…åˆ é™¤ï¼‰

```cmd
python test_sync.py
```

### 2. æ¨¡æ‹ŸåŒæ­¥

```cmd
python sync_metadata.py --dry-run
```

### 3. æ‰§è¡ŒåŒæ­¥

```cmd
python sync_metadata.py
```

### 4. éªŒè¯ç»“æœ

```cmd
# æŸ¥çœ‹å…ƒæ•°æ®è¡¨
type metadata\source_table.csv

# æŸ¥çœ‹æ•°æ®åº“
sqlite3 upload_log.db "SELECT COUNT(*) FROM upload_log"

# æˆ–ç”¨ Python
python -c "from utils.metadata_manager import MetadataManager; m = MetadataManager('./metadata/source_table.csv'); print(f'å…ƒæ•°æ®è®°å½•æ•°: {m.count()}')"
```

## é…ç½®å»ºè®®

### æ¨èé…ç½®ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰

```yaml
# config.yaml

metadata:
  enabled: true
  csv_path: "./metadata/source_table.csv"
  auto_create: true

database:
  enabled: true
  sqlite_path: "./upload_log.db"
  skip_uploaded: true
  auto_sync: true  # â­ å¯ç”¨è‡ªåŠ¨åŒæ­¥
```

### æ‰‹åŠ¨åŒæ­¥é…ç½®

```yaml
database:
  auto_sync: false  # ç¦ç”¨è‡ªåŠ¨åŒæ­¥ï¼Œæ‰‹åŠ¨æ‰§è¡Œ
```

## å¸¸è§é—®é¢˜

### Q1: åŒæ­¥ä¼šè¯¯åˆ æœ‰æ•ˆæ•°æ®å—ï¼Ÿ

**A:** ä¸ä¼šã€‚åŒæ­¥é€»è¾‘æ˜¯ï¼š
```
æœ¬åœ°è®°å½• - Dify å®é™…æ–‡æ¡£ = éœ€è¦åˆ é™¤çš„è®°å½•
```

åªåˆ é™¤ Dify ä¸­**ä¸å­˜åœ¨**çš„è®°å½•ã€‚

### Q2: ä¸ºä»€ä¹ˆå…ƒæ•°æ®è¡¨å’Œæ•°æ®åº“åˆ é™¤æ•°é‡ä¸åŒï¼Ÿ

**A:** è¿™æ˜¯æ­£å¸¸çš„ï¼š
- **æ•°æ®åº“**ï¼šæ¯æ¬¡ä¸Šä¼ éƒ½è®°å½•ï¼ˆå¯èƒ½é‡å¤ä¸Šä¼ ï¼‰
- **å…ƒæ•°æ®è¡¨**ï¼šæ¯ä¸ªæ–‡æ¡£ä¸€æ¡è®°å½•ï¼ˆä¸é‡å¤ï¼‰

ä¾‹å¦‚ï¼š
- ä¸Šä¼  `æ–‡æ¡£.pdf` 3 æ¬¡ â†’ æ•°æ®åº“ 3 æ¡è®°å½•
- å…ƒæ•°æ®è¡¨åªæœ‰ 1 æ¡è®°å½•
- åˆ é™¤åï¼šæ•°æ®åº“åˆ  3 æ¡ï¼Œå…ƒæ•°æ®åˆ  1 æ¡

### Q3: æ¨¡ç³ŠåŒ¹é…ä¼šè¯¯åˆ å—ï¼Ÿ

**A:** åŒ¹é…ç®—æ³•å·²ä¼˜åŒ–ï¼š
1. ç²¾ç¡®åŒ¹é…ä¼˜å…ˆ
2. å»é™¤ç‰¹æ®Šå­—ç¬¦åå¯¹æ¯”
3. åŒå‘åŒ…å«å…³ç³»æ£€æŸ¥

å»ºè®®ï¼š
- å…ˆç”¨ `--dry-run` é¢„è§ˆ
- ç¡®è®¤æ— è¯¯åæ‰§è¡Œ

### Q4: å¯ä»¥æ¢å¤è¯¯åˆ çš„è®°å½•å—ï¼Ÿ

**A:** å»ºè®®å®šæœŸå¤‡ä»½ï¼š
```cmd
# å¤‡ä»½è„šæœ¬
copy metadata\source_table.csv metadata\source_table.backup.csv
copy upload_log.db upload_log.backup.db
```

æˆ–ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ï¼š
```cmd
git add metadata\source_table.csv upload_log.db
git commit -m "å¤‡ä»½å…ƒæ•°æ®"
```

## ç›¸å…³æ–‡æ¡£

- **[METADATA_SYNC_GUIDE.md](METADATA_SYNC_GUIDE.md)** - å®Œæ•´ä½¿ç”¨æŒ‡å—
- **[SYNC_GUIDE.md](SYNC_GUIDE.md)** - æ•°æ®åº“åŒæ­¥è¯´æ˜
- **[README_enhanced.md](README_enhanced.md)** - å¢å¼ºç‰ˆä½¿ç”¨è¯´æ˜

## æ€»ç»“

âœ… **å…ƒæ•°æ®è¡¨åŒæ­¥åŠŸèƒ½å·²å®Œå…¨å®ç°ï¼**

ç°åœ¨åŒæ­¥åŠŸèƒ½åŒ…æ‹¬ï¼š
- âœ… SQLite æ•°æ®åº“åŒæ­¥ï¼ˆæ–‡æ¡£ ID ç²¾ç¡®åŒ¹é…ï¼‰
- âœ… CSV å…ƒæ•°æ®è¡¨åŒæ­¥ï¼ˆæ–‡ä»¶åæ™ºèƒ½åŒ¹é…ï¼‰
- âœ… è‡ªåŠ¨åŒæ­¥æ¨¡å¼ï¼ˆå¯åŠ¨æ—¶ï¼‰
- âœ… æ‰‹åŠ¨åŒæ­¥å·¥å…·ï¼ˆ--dry-run æ”¯æŒï¼‰
- âœ… æ‰¹å¤„ç†ç•Œé¢ï¼ˆWindows å‹å¥½ï¼‰
- âœ… æµ‹è¯•è„šæœ¬ï¼ˆå®‰å…¨æµ‹è¯•ï¼‰

**æ¨èé…ç½®ï¼š**
```yaml
database:
  auto_sync: true  # æ¯æ¬¡å¯åŠ¨è‡ªåŠ¨åŒæ­¥ä¸¤ä¸ªå­˜å‚¨
```

**é—®é¢˜å·²è§£å†³ï¼** ğŸ‰

---

**å®Œæˆæ—¶é—´**: 2025-11-17  
**ä¿®æ”¹æ–‡ä»¶**: 6 ä¸ª  
**æ–°å¢ä»£ç **: ~200 è¡Œ  
**æµ‹è¯•çŠ¶æ€**: âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡
