# 🔄 Dify 实时监控功能

## 功能说明

**新增功能**：在监听本地文件夹新增文件的同时，**实时监控 Dify 知识库的变化**，自动检测文档删除并同步更新本地元数据表和数据库。

## 工作原理

### 双线程监控架构

```
┌─────────────────────────────────────────────────────────┐
│                    主程序                                │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌─────────────────┐         ┌────────────────────┐   │
│  │  文件系统监控    │         │  Dify 知识库监控   │   │
│  │  (watchdog)     │         │  (定时检查)        │   │
│  └────────┬────────┘         └─────────┬──────────┘   │
│           │                             │               │
│           │ 检测新文件                  │ 定期检查      │
│           ↓                             ↓               │
│  ┌─────────────────┐         ┌────────────────────┐   │
│  │  • 自动上传      │         │  • 检测删除        │   │
│  │  • 记录元数据    │         │  • 自动同步        │   │
│  │  • 记录日志      │         │  • 清理记录        │   │
│  └─────────────────┘         └────────────────────┘   │
│           │                             │               │
│           └──────────┬──────────────────┘               │
│                      ↓                                  │
│          ┌───────────────────────┐                     │
│          │  本地存储              │                     │
│          │  • upload_log.db      │                     │
│          │  • source_table.csv   │                     │
│          └───────────────────────┘                     │
└─────────────────────────────────────────────────────────┘
```

### 监控流程

1. **启动时**
   - 初始化文件系统监控（watchdog）
   - 启动 Dify 监控线程（后台运行）
   - 获取 Dify 当前文档列表作为基准

2. **运行中**
   - **文件监控**：实时检测本地文件夹新增/修改文件
   - **Dify 监控**：每隔 N 秒检查 Dify 知识库变化
   
3. **检测到删除**
   - 对比当前文档列表与上次缓存
   - 找出已删除的文档
   - 自动同步删除本地记录

## 配置说明

### config.yaml

```yaml
# Dify 实时监控配置
monitor:
  enabled: true              # 启用实时监控
  check_interval: 60         # 检查间隔（秒）
```

### 配置项说明

| 配置项 | 说明 | 默认值 | 推荐值 |
|-------|------|--------|--------|
| `enabled` | 是否启用实时监控 | `true` | `true` |
| `check_interval` | 检查间隔（秒） | `60` | 30-300 秒 |

### 间隔时间建议

| 场景 | 推荐间隔 | 说明 |
|-----|---------|------|
| 高频删除 | 30 秒 | 快速响应，但 API 请求较多 |
| 正常使用 | 60 秒 | ⭐ 推荐，平衡性能和及时性 |
| 低频使用 | 300 秒（5 分钟） | 减少 API 请求 |

## 使用方法

### 启动监控

```cmd
# 使用增强版脚本（自动启用双监控）
python upload_enhanced.py
```

**输出示例：**
```
[INFO] 开始监控文件夹: C:\Users\Moon\Desktop\...
[INFO] ✨ Dify 实时监控已启动（每 60 秒检查一次）
[INFO] [监控] 初始化完成，当前 22 个文档
[INFO] 监控服务已启动，按 Ctrl+C 停止...
```

### 监控运行中

**检测到删除时：**
```
[WARNING] [监控] 检测到文档删除：3 个
[SUCCESS] [监控] ✅ 自动同步：数据库 3 条，元数据表 3 条
```

**检测到新增时（仅记录）：**
```
[INFO] [监控] 检测到新文档：2 个
```

### 停止监控

```
按 Ctrl+C

[INFO] 收到停止信号，正在停止监控...
[INFO] [监控] 正在停止 Dify 监控...
[INFO] [监控] 已停止（检查 15 次，同步删除 6 条）
[INFO] 监控服务已停止
```

## 功能特性

### ✅ 实时检测

- **文件新增**：毫秒级响应（watchdog）
- **文档删除**：秒级响应（定时检查）
- **自动同步**：检测到变化立即同步

### ✅ 智能匹配

- **数据库**：通过文档 ID 精确匹配
- **元数据表**：通过文件名智能匹配
  - 移除扩展名（`.pdf`, `_ocr.md`）
  - 去除特殊字符（`《》（）`）
  - 模糊对比（包含关系）

### ✅ 后台运行

- 守护线程，不阻塞主程序
- 异常自动恢复
- 主程序退出时自动清理

### ✅ 统计信息

监控停止时显示：
- 检查次数
- 同步删除总数

## 日志说明

### 日志前缀

| 前缀 | 说明 |
|-----|------|
| `[监控]` | Dify 监控线程输出 |
| 无前缀 | 文件系统监控输出 |

### 日志级别

| 级别 | 说明 | 示例 |
|-----|------|------|
| `[INFO]` | 普通信息 | 初始化、检测新文档 |
| `[WARNING]` | 警告 | 检测到删除 |
| `[SUCCESS]` | 成功操作 | 同步完成 |
| `[ERROR]` | 错误 | API 调用失败 |

## 性能影响

### API 请求

**每次检查的请求：**
- 获取文档列表：1-N 次（取决于文档数量）
  - 每页 100 个文档
  - 例如：250 个文档 = 3 次请求

**每小时请求数估算：**
- 间隔 60 秒：约 60 次/小时
- 间隔 300 秒：约 12 次/小时

### 资源占用

- **CPU**：几乎无影响（休眠等待）
- **内存**：约 5-10 MB（缓存文档列表）
- **网络**：每次检查约 1-10 KB

## 禁用监控

### 方式 1：配置文件

```yaml
monitor:
  enabled: false  # 禁用实时监控
```

### 方式 2：调整间隔

```yaml
monitor:
  enabled: true
  check_interval: 300  # 改为 5 分钟检查一次
```

### 方式 3：使用手动同步

禁用实时监控后，使用手动同步工具：

```cmd
# 定期手动执行
python sync_metadata.py
```

## 故障排查

### 问题 1：监控未启动

**检查：**
```yaml
monitor:
  enabled: true  # 确保为 true
```

**日志：**
```
[INFO] ✨ Dify 实时监控已启动  # 应该看到这条日志
```

### 问题 2：未检测到删除

**可能原因：**
1. 检查间隔过长，等待下次检查
2. 文件名匹配问题

**解决：**
```yaml
monitor:
  check_interval: 30  # 缩短间隔
```

### 问题 3：误删除记录

**原因：** 文件名匹配算法误判

**解决：**
1. 查看日志确认删除的记录
2. 从备份恢复
3. 调整元数据表标题格式

### 问题 4：API 请求失败

**日志：**
```
[WARNING] [监控] 获取 Dify 文档列表失败: 503
```

**解决：**
- 检查网络连接
- 检查 Dify 服务状态
- 增加检查间隔减少请求频率

## 对比：自动 vs 手动同步

| 特性 | 实时监控 | 启动时同步 | 手动同步 |
|-----|---------|-----------|---------|
| 触发方式 | 定时检查 | 启动时一次 | 手动执行 |
| 响应速度 | 秒级 | 启动时 | 即时 |
| 资源占用 | 低（后台） | 无 | 无 |
| 适用场景 | ⭐ 长期运行 | 间歇运行 | 偶尔维护 |

## 最佳实践

### 推荐配置

```yaml
# config.yaml

# 启动时同步一次
database:
  auto_sync: true

# 运行时实时监控
monitor:
  enabled: true
  check_interval: 60
```

### 使用场景

**场景 1：7x24 小时运行**
```yaml
monitor:
  enabled: true
  check_interval: 60  # 1 分钟检查
```

**场景 2：工作时间运行**
```yaml
monitor:
  enabled: true
  check_interval: 300  # 5 分钟检查
```

**场景 3：按需运行**
```yaml
monitor:
  enabled: false  # 禁用实时监控

database:
  auto_sync: true  # 仅启动时同步
```

## 技术实现

### DifyMonitor 类

```python
class DifyMonitor(threading.Thread):
    """Dify 知识库监控线程"""
    
    def __init__(self, config, upload_logger, metadata_manager, check_interval=60):
        # 守护线程，主程序退出时自动结束
        self.daemon = True
        self.check_interval = check_interval
        
    def run(self):
        """运行监控循环"""
        while self.running:
            self.check_for_changes()
            time.sleep(self.check_interval)
    
    def check_for_changes(self):
        """检查变化并同步"""
        current_docs = self.get_dify_documents()
        deleted_ids = self.current_doc_ids - current_ids
        if deleted_ids:
            self.sync_deletions(current_docs)
```

### 线程安全

- 使用 Python GIL 保护
- 守护线程模式
- 异常捕获防止崩溃

## 测试建议

### 测试步骤

1. **启动监控**
   ```cmd
   python upload_enhanced.py
   ```

2. **在 Dify 中删除文档**
   - 打开 Dify 知识库
   - 删除一个文档

3. **等待检查**
   - 等待一个检查间隔（默认 60 秒）
   - 观察日志输出

4. **验证结果**
   ```cmd
   # 查看元数据表
   type metadata\source_table.csv
   
   # 查看数据库
   python -c "from utils.upload_logger import UploadLogger; u = UploadLogger('./upload_log.db'); print(f'记录数: {u.get_statistics()}')"
   ```

### 预期输出

```
[INFO] [监控] 初始化完成，当前 22 个文档
... 等待 60 秒 ...
[WARNING] [监控] 检测到文档删除：1 个
[SUCCESS] [监控] ✅ 自动同步：数据库 1 条，元数据表 1 条
```

## 常见问题

### Q1: 实时监控和启动时同步有什么区别？

**A:** 
- **启动时同步** (`auto_sync`): 只在程序启动时同步一次
- **实时监控** (`monitor.enabled`): 运行期间定期检查，持续同步

推荐两者都启用，互补使用。

### Q2: 会不会频繁调用 API？

**A:** 默认 60 秒一次，每小时约 60 次请求，不会造成压力。
- Dify API 通常无速率限制
- 每次请求很小（几 KB）
- 可调整间隔减少请求

### Q3: 能检测新增的文档吗？

**A:** 可以检测，但只会记录日志，不会自动下载。
- 新增检测：仅用于统计
- 删除检测：自动同步本地

### Q4: 主程序退出后监控线程会停止吗？

**A:** 会自动停止。
- 监控线程设为守护线程（daemon=True）
- 主程序退出时自动清理

### Q5: 如果检查时网络断开会怎样？

**A:** 会记录警告日志，但不会影响主程序。
- 自动捕获异常
- 下次检查继续尝试
- 主程序正常运行

## 相关文件

- `utils/dify_monitor.py` - Dify 监控模块（新增）
- `upload_enhanced.py` - 主脚本（集成监控）
- `config.yaml` - 配置文件（新增 monitor 配置）
- `METADATA_SYNC_GUIDE.md` - 元数据同步指南

## 总结

✅ **实时监控功能已完成！**

现在系统支持：
- ✅ 本地文件夹监控（新增文件）
- ✅ Dify 知识库监控（删除文档）
- ✅ 自动同步元数据表和数据库
- ✅ 双线程并行工作
- ✅ 后台守护运行

**推荐配置：**
```yaml
monitor:
  enabled: true          # 启用实时监控
  check_interval: 60     # 每分钟检查
```

**一键启动：**
```cmd
python upload_enhanced.py
```

现在你可以放心运行，系统会自动保持本地和 Dify 的数据一致性！🎉

---

**实现日期**: 2025-11-17  
**新增文件**: `utils/dify_monitor.py`  
**修改文件**: `upload_enhanced.py`, `config.yaml`, `config.yaml.example`
