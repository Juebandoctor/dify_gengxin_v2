# 元数据同步功能说明

## 问题描述

**原问题**：在 Dify 知识库中删除文件后，本地的 `metadata/source_table.csv` 元数据表格中的记录没有同步删除，导致数据不一致。

**已解决**：现在同步功能会同时清理：
1. ✅ SQLite 数据库记录（`upload_log.db`）
2. ✅ CSV 元数据表记录（`metadata/source_table.csv`）

## 使用方法

### 方式 1：自动同步（推荐）⭐

**配置文件设置：**
```yaml
# config.yaml
database:
  enabled: true
  auto_sync: true  # 启动时自动同步
```

**效果：**
- 每次启动 `python upload_enhanced.py` 时自动同步
- 同时清理数据库和元数据表

**日志输出：**
```
[INFO] 开始与 Dify 同步...
[SUCCESS] ✅ 同步完成：数据库 2 条，元数据表 2 条
```

### 方式 2：手动同步

**使用命令：**
```cmd
# 1. 模拟运行（查看将要删除什么）
python sync_metadata.py --dry-run

# 2. 确认无误后，正式同步
python sync_metadata.py
```

**输出示例：**
```
========================================
  Dify 文档同步工具
========================================

[INFO] 本地数据库中有 25 条上传记录
[INFO] 本地元数据表中有 28 条记录
[INFO] 正在从 Dify 获取文档列表...
[SUCCESS] 成功获取 22 个文档
[INFO] Dify 知识库中有 22 个文档

==================================================
[WARNING] 数据库：发现 3 条需要清理的记录
[WARNING] 元数据表：发现 6 条需要清理的记录

待删除的数据库记录（文档 ID）：
  1. 0a09c548-6232-4a...
  2. 9f8f3bc4-b8fc-4f...
  3. 1234abcd-5678-ef...

待删除的元数据记录（标题）：
  1. 2025-已删除的文档1
  2. 2024-已删除的文档2
  3. 历史遗留文档3
  ... 以及其他 3 条记录
==================================================

是否继续删除这些记录？[y/N]: y

[SUCCESS] ✅ 数据库：成功删除 3 条记录
[SUCCESS] ✅ 元数据表：成功删除 6 条记录

🎉 同步完成！总共删除 9 条记录
```

### 方式 3：批处理工具

```cmd
# 双击运行
sync_dify.bat

# 选择：
#   1 - 模拟运行
#   2 - 正式同步
#   0 - 退出
```

## 工作原理

### 同步逻辑

```
┌──────────────────┐
│ Dify 知识库      │
│ 22 个文档        │
└────────┬─────────┘
         │
         │ 对比
         ↓
┌──────────────────┐      ┌──────────────────┐
│ 本地数据库       │      │ 元数据表 CSV     │
│ 25 条记录        │      │ 28 条记录        │
└────────┬─────────┘      └────────┬─────────┘
         │                         │
         │ 差集：3 条              │ 差集：6 条
         ↓                         ↓
    删除 3 条                  删除 6 条
```

### 匹配方式

**数据库记录**：通过 **文档 ID** 精确匹配
- Dify 文档 ID：`0a09c548-6232-4a...`
- 数据库记录 ID：完全一致才保留

**元数据表记录**：通过 **文件名** 模糊匹配
- Dify 文档名：`2025-国土空间规划意见_ocr.md`
- 元数据标题：`2025-《关于强化国土空间规划...》`
- 匹配规则：
  1. 移除特殊字符：`《》（）[]`
  2. 模糊对比：包含关系
  3. 大小写不敏感

### 文件名处理

同步时会智能处理各种文件名格式：

| Dify 文档名 | 处理后 | 元数据标题 | 匹配结果 |
|-----------|--------|----------|---------|
| `文档_ocr.md` | `文档` | `文档` | ✅ 匹配 |
| `2025-政策.pdf` | `2025-政策` | `2025-《政策》` | ✅ 匹配 |
| `指南(试行).docx` | `指南(试行)` | `指南（试行）` | ✅ 匹配 |

## 配置说明

### config.yaml

```yaml
# 元数据配置
metadata:
  enabled: true
  csv_path: "./metadata/source_table.csv"
  auto_create: true

# 数据库配置
database:
  enabled: true
  sqlite_path: "./upload_log.db"
  skip_uploaded: true
  auto_sync: true  # ⭐ 启用自动同步（同时清理数据库和CSV）
```

## 新增功能

### MetadataManager 类

新增方法：

```python
# 删除单条记录
metadata_manager.delete_by_title("文档标题")

# 批量删除
metadata_manager.delete_by_titles(["标题1", "标题2", "标题3"])

# 获取所有标题
titles = metadata_manager.get_all_titles()

# 获取记录总数
count = metadata_manager.count()
```

### 同步工具

增强的 `sync_metadata.py`：
- ✅ 同时同步数据库和 CSV
- ✅ 显示两类记录的差异
- ✅ 分别统计删除数量
- ✅ 支持模拟运行（--dry-run）

## 测试

### 测试脚本

```cmd
# 运行测试（不会实际删除）
python test_sync.py
```

**输出示例：**
```
============================================================
测试元数据同步功能
============================================================
[INFO] 元数据文件: ./metadata/source_table.csv
[INFO] 当前记录数: 15

当前元数据记录：
  1. 2025-《关于强化国土空间规划...》
  2. 2025.10-省级国土空间生态修复...
  3. 安徽省全域土地综合整治...
  ... 以及其他 12 条记录

============================================================
[WARNING] 以下是测试模式，不会实际删除
============================================================

假设 Dify 中只有 5 个文档

模拟删除 10 条记录：
  1. 文档6
  2. 文档7
  ... 以及其他 8 条记录

============================================================
[SUCCESS] ✅ 测试完成！实际使用请运行：python sync_metadata.py
============================================================
```

### 完整测试流程

1. **查看当前状态**
   ```cmd
   python test_sync.py
   ```

2. **模拟同步**
   ```cmd
   python sync_metadata.py --dry-run
   ```

3. **确认无误后执行**
   ```cmd
   python sync_metadata.py
   ```

4. **验证结果**
   ```cmd
   # 查看 CSV 文件
   type metadata\source_table.csv
   
   # 查看数据库
   sqlite3 upload_log.db "SELECT COUNT(*) FROM upload_log"
   ```

## 常见问题

### Q1: 会误删有效数据吗？

**A:** 不会。同步逻辑：
1. 从 Dify 获取**实际存在**的文档
2. 本地记录 **减去** Dify 文档 = 需要删除的记录
3. 只删除 Dify 中**已不存在**的记录

### Q2: 元数据匹配不准确怎么办？

**A:** 匹配规则已优化：
- ✅ 移除特殊字符
- ✅ 模糊匹配（包含关系）
- ✅ 处理 `_ocr.md` 后缀

如果仍不准确：
1. 使用 `--dry-run` 预览
2. 手动调整元数据标题格式
3. 运行同步

### Q3: 可以恢复误删的记录吗？

**A:** 建议定期备份：

```cmd
# 备份数据库
copy upload_log.db upload_log.backup.db

# 备份元数据表
copy metadata\source_table.csv metadata\source_table.backup.csv

# 或使用版本控制
git add metadata\source_table.csv upload_log.db
git commit -m "备份元数据"
```

### Q4: 同步频率建议？

**推荐配置：**
```yaml
database:
  auto_sync: true  # 每次启动自动同步
```

**手动同步场景：**
- 批量删除 Dify 文档后
- 发现数据不一致时
- 定期维护（如每周）

### Q5: 元数据表和数据库不一致？

这是正常的：
- **数据库**：记录所有上传历史（精确到每次上传）
- **元数据表**：记录文档元信息（一个文档一条）

同步会分别清理两者的冗余记录。

## 更新日志

### 2025-11-17

**新增功能：**
- ✅ MetadataManager 支持删除操作
- ✅ sync_metadata.py 同时同步 CSV 和数据库
- ✅ upload_enhanced.py 自动同步包含元数据表
- ✅ 智能文件名匹配（处理 _ocr.md 等）
- ✅ 分别统计和显示删除数量

**修复问题：**
- ✅ 解决元数据表不同步删除的问题
- ✅ 优化匹配算法（去除特殊字符）

## 相关文件

- `sync_metadata.py` - 同步工具（增强）
- `utils/metadata_manager.py` - 元数据管理器（新增删除方法）
- `upload_enhanced.py` - 主脚本（自动同步包含CSV）
- `test_sync.py` - 测试脚本（新增）
- `sync_dify.bat` - 批处理工具

## 总结

✅ **现在同步功能完整！**

包含：
- ✅ SQLite 数据库同步
- ✅ CSV 元数据表同步
- ✅ 自动同步模式
- ✅ 手动同步工具
- ✅ 模拟运行模式
- ✅ 智能文件名匹配

**推荐配置：**
```yaml
database:
  auto_sync: true  # 启动时自动同步两个存储
```

这样就能确保数据库和元数据表始终与 Dify 保持一致！🎉
